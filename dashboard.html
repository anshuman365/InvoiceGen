<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - InvoiceGen | Manage Your Invoices</title>
    <meta name="description" content="InvoiceGen dashboard - Manage your invoices, track revenue, and monitor your business performance in one place.">
    <meta name="keywords" content="invoice dashboard, billing management, revenue tracking, invoice analytics">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Dashboard - InvoiceGen">
    <meta property="og:description" content="Manage your invoices, track revenue, and monitor your business performance in one place.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://invoicegen.example.com/dashboard.html">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="InvoiceGen">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icons/favicon-16x16.png">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Date-fns for date manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <!-- Custom Styles -->
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-file-invoice-dollar"></i> InvoiceGen
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="invoices.html">
                            <i class="fas fa-file-invoice me-1"></i> Invoices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-invoice.html">
                            <i class="fas fa-plus-circle me-1"></i> Create Invoice
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="billing.html">
                            <i class="fas fa-wallet me-1"></i> Billing
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> 
                            <span id="user-name">Account</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-link"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="container">
            <!-- Welcome Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 fw-bold text-primary mb-1">Dashboard</h1>
                            <p class="text-muted mb-0" id="welcome-message">Welcome back! Here's your business overview.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="create-invoice.html" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>New Invoice
                            </a>
                            <button class="btn btn-outline-secondary" id="refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-primary rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="total-invoices">0</h2>
                                    <p class="card-text mb-0">Total Invoices</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><i class="fas fa-arrow-up me-1"></i> <span id="invoice-growth">0%</span> from last month</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-success rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="total-revenue">$0.00</h2>
                                    <p class="card-text mb-0">Total Revenue</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><i class="fas fa-arrow-up me-1"></i> <span id="revenue-growth">0%</span> from last month</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-info rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="free-invoices">0</h2>
                                    <p class="card-text mb-0">Free Invoices Left</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-gift"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small id="invoice-status">You're on the free plan</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-warning rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="outstanding-amount">$0.00</h2>
                                    <p class="card-text mb-0">Outstanding</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><span id="pending-invoices">0</span> unpaid invoices</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="row">
                <!-- Revenue Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Revenue Overview</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="chartPeriodDropdown">
                                    Last 6 Months
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item chart-period" data-period="3">Last 3 Months</a></li>
                                    <li><a class="dropdown-item chart-period active" data-period="6">Last 6 Months</a></li>
                                    <li><a class="dropdown-item chart-period" data-period="12">Last 12 Months</a></li>
                                    <li><a class="dropdown-item chart-period" data-period="0">All Time</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Status Distribution -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="create-invoice.html" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus-circle me-2"></i>Create New Invoice
                                </a>
                                <a href="invoices.html" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>View All Invoices
                                </a>
                                <a href="billing.html" class="btn btn-outline-primary">
                                    <i class="fas fa-wallet me-2"></i>Manage Billing
                                </a>
                                <a href="settings.html" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>Account Settings
                                </a>
                            </div>

                            <!-- Account Status -->
                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="fw-semibold text-muted">Account Status</h6>
                                <div id="account-status-badge" class="badge bg-secondary mb-2">Free Plan</div>
                                <p class="small mb-2 text-muted" id="plan-details">10 free invoices per month</p>
                                <a href="billing.html" class="btn btn-sm btn-warning w-100">
                                    <i class="fas fa-crown me-1"></i>Upgrade Plan
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Distribution Chart -->
                    <div class="card mt-4">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Invoice Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 200px;">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Invoices & Activity -->
            <div class="row">
                <!-- Recent Invoices -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Recent Invoices</h5>
                            <a href="invoices.html" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" id="recent-invoices-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted">Loading your invoices...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity & Monthly Trends -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <div class="activity-timeline" id="activity-timeline">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted small">Loading activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Trends -->
                    <div class="card mt-4">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Monthly Trends</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-1" id="current-month-invoices">0</h4>
                                        <small class="text-muted">This Month</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 class="text-success mb-1" id="current-month-revenue">$0</h4>
                                    <small class="text-muted">This Month</small>
                                </div>
                                <div class="col-6">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-1" id="last-month-invoices">0</h4>
                                        <small class="text-muted">Last Month</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success mb-1" id="last-month-revenue">$0</h4>
                                    <small class="text-muted">Last Month</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support Card -->
                    <div class="card mt-4 bg-light">
                        <div class="card-body text-center">
                            <i class="fas fa-headset fa-2x text-primary mb-3"></i>
                            <h6>Need Help?</h6>
                            <p class="small text-muted mb-3">Our support team is here to help you</p>
                            <a href="#" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-envelope me-1"></i>Contact Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2023 InvoiceGen. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="main.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>

    <script>
        // Check authentication
        if (!window.api.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Global variables for charts
        let revenueChart, statusChart;
        let currentChartPeriod = 6; // Default to 6 months

        // Logout handler
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            window.api.logout();
        });

        // Refresh button handler
        document.getElementById('refresh-btn').addEventListener('click', function() {
            const button = this;
            const icon = button.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            loadDashboard();
            
            // Remove spinning after 2 seconds
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 2000);
        });

        // Chart period selector
        document.querySelectorAll('.chart-period').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active class
                document.querySelectorAll('.chart-period').forEach(el => {
                    el.classList.remove('active');
                });
                this.classList.add('active');
                
                // Update dropdown text
                const periodText = this.textContent;
                document.getElementById('chartPeriodDropdown').textContent = periodText;
                
                // Update chart period and reload
                currentChartPeriod = parseInt(this.getAttribute('data-period'));
                loadDashboard();
            });
        });

        // Revenue Chart initialization
        function initRevenueChart(labels, data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Revenue: ${window.api.formatCurrency(context.parsed.y, defaultCurrency)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return window.api.formatCurrency(value, defaultCurrency);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Status Chart initialization
        function initStatusChart(statusData) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (statusChart) {
                statusChart.destroy();
            }
            
            const backgroundColors = [
                'rgba(40, 167, 69, 0.8)',   // Paid - Green
                'rgba(255, 193, 7, 0.8)',   // Pending - Yellow
                'rgba(220, 53, 69, 0.8)',   // Overdue - Red
                'rgba(108, 117, 125, 0.8)'  // Cancelled - Gray
            ];
            
            const borderColors = [
                'rgb(40, 167, 69)',   // Paid - Green
                'rgb(255, 193, 7)',   // Pending - Yellow
                'rgb(220, 53, 69)',   // Overdue - Red
                'rgb(108, 117, 125)'  // Cancelled - Gray
            ];
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Pending', 'Overdue', 'Cancelled'],
                    datasets: [{
                        data: [
                            statusData.paid || 0,
                            statusData.pending || 0,
                            statusData.overdue || 0,
                            statusData.cancelled || 0
                        ],
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        // Process invoice data for charts
        function processInvoiceData(invoices, period) {
            const now = new Date();
            let startDate;
            
            if (period === 0) {
                // All time - use the earliest invoice date
                startDate = invoices.length > 0 ? 
                    new Date(Math.min(...invoices.map(i => new Date(i.issue_date)))) : 
                    new Date(now.getFullYear(), now.getMonth() - 5, 1); // Default to 6 months back
            } else {
                startDate = new Date(now.getFullYear(), now.getMonth() - period, 1);
            }
            
            // Filter invoices by date
            const filteredInvoices = invoices.filter(invoice => {
                const invoiceDate = new Date(invoice.issue_date);
                return invoiceDate >= startDate;
            });
            
            // Group by month and calculate totals
            const monthlyData = {};
            const statusCounts = {
                paid: 0,
                pending: 0,
                overdue: 0,
                cancelled: 0
            };
            
            let currentMonthInvoices = 0;
            let currentMonthRevenue = 0;
            let lastMonthInvoices = 0;
            let lastMonthRevenue = 0;
            
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            filteredInvoices.forEach(invoice => {
                const invoiceDate = new Date(invoice.issue_date);
                const monthYear = `${invoiceDate.getFullYear()}-${invoiceDate.getMonth()}`;
                
                // Initialize month if not exists
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        total: 0,
                        count: 0,
                        label: invoiceDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                    };
                }
                
                // Add to monthly total
                monthlyData[monthYear].total += invoice.total;
                monthlyData[monthYear].count += 1;
                
                // Count by status
                if (statusCounts.hasOwnProperty(invoice.status)) {
                    statusCounts[invoice.status] += 1;
                }
                
                // Calculate current and last month stats
                if (invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear) {
                    currentMonthInvoices += 1;
                    currentMonthRevenue += invoice.total;
                } else if (invoiceDate.getMonth() === lastMonth && invoiceDate.getFullYear() === lastMonthYear) {
                    lastMonthInvoices += 1;
                    lastMonthRevenue += invoice.total;
                }
            });
            
            // Convert to arrays for chart
            const months = [];
            const revenueData = [];
            
            // Create array of all months in the period
            const allMonths = [];
            let current = new Date(startDate);
            
            while (current <= now) {
                const monthYear = `${current.getFullYear()}-${current.getMonth()}`;
                allMonths.push({
                    key: monthYear,
                    label: current.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                });
                current.setMonth(current.getMonth() + 1);
            }
            
            // Fill in data for all months
            allMonths.forEach(month => {
                months.push(month.label);
                revenueData.push(monthlyData[month.key] ? monthlyData[month.key].total : 0);
            });
            
            return {
                months,
                revenueData,
                statusCounts,
                currentMonth: {
                    invoices: currentMonthInvoices,
                    revenue: currentMonthRevenue
                },
                lastMonth: {
                    invoices: lastMonthInvoices,
                    revenue: lastMonthRevenue
                }
            };
        }

        // Generate activity timeline
        function generateActivityTimeline(invoices) {
            const activities = [];
            const now = new Date();
            
            // Create activities from recent invoices
            invoices.slice(0, 10).forEach(invoice => {
                const invoiceDate = new Date(invoice.created_at || invoice.issue_date);
                const timeDiff = now - invoiceDate;
                const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutesDiff = Math.floor(timeDiff / (1000 * 60));
                
                let timeAgo;
                if (minutesDiff < 60) {
                    timeAgo = minutesDiff <= 1 ? 'just now' : `${minutesDiff} minutes ago`;
                } else if (hoursDiff < 24) {
                    timeAgo = hoursDiff === 1 ? '1 hour ago' : `${hoursDiff} hours ago`;
                } else if (daysDiff < 7) {
                    timeAgo = daysDiff === 1 ? '1 day ago' : `${daysDiff} days ago`;
                } else {
                    timeAgo = invoiceDate.toLocaleDateString();
                }
                
                activities.push({
                    type: 'invoice_created',
                    icon: 'fas fa-file-invoice',
                    iconColor: 'text-primary',
                    title: 'New invoice created',
                    description: `Invoice #${invoice.invoice_number} for ${invoice.client_name}`,
                    time: timeAgo,
                    timestamp: invoiceDate
                });
                
                // If invoice was sent, add sent activity
                if (invoice.last_sent_at) {
                    const sentDate = new Date(invoice.last_sent_at);
                    const sentTimeDiff = now - sentDate;
                    const sentDaysDiff = Math.floor(sentTimeDiff / (1000 * 60 * 60 * 24));
                    
                    let sentTimeAgo;
                    if (sentDaysDiff === 0) {
                        sentTimeAgo = 'today';
                    } else if (sentDaysDiff === 1) {
                        sentTimeAgo = 'yesterday';
                    } else if (sentDaysDiff < 7) {
                        sentTimeAgo = `${sentDaysDiff} days ago`;
                    } else {
                        sentTimeAgo = sentDate.toLocaleDateString();
                    }
                    
                    activities.push({
                        type: 'invoice_sent',
                        icon: 'fas fa-paper-plane',
                        iconColor: 'text-success',
                        title: 'Invoice sent to client',
                        description: `Invoice #${invoice.invoice_number} sent to ${invoice.client_email || 'client'}`,
                        time: sentTimeAgo,
                        timestamp: sentDate
                    });
                }
                
                // If invoice is paid, add payment activity
                if (invoice.status === 'paid' && invoice.payment_date) {
                    const paymentDate = new Date(invoice.payment_date);
                    const paymentTimeDiff = now - paymentDate;
                    const paymentDaysDiff = Math.floor(paymentTimeDiff / (1000 * 60 * 60 * 24));
                    
                    let paymentTimeAgo;
                    if (paymentDaysDiff === 0) {
                        paymentTimeAgo = 'today';
                    } else if (paymentDaysDiff === 1) {
                        paymentTimeAgo = 'yesterday';
                    } else if (paymentDaysDiff < 7) {
                        paymentTimeAgo = `${paymentDaysDiff} days ago`;
                    } else {
                        paymentTimeAgo = paymentDate.toLocaleDateString();
                    }
                    
                    activities.push({
                        type: 'invoice_paid',
                        icon: 'fas fa-check-circle',
                        iconColor: 'text-success',
                        title: 'Invoice paid',
                        description: `Invoice #${invoice.invoice_number} marked as paid`,
                        time: paymentTimeAgo,
                        timestamp: paymentDate
                    });
                }
            });
            
            // Sort activities by timestamp (newest first)
            activities.sort((a, b) => b.timestamp - a.timestamp);
            
            // Take only the 5 most recent activities
            return activities.slice(0, 5);
        }

        // Global variable for default currency
        let defaultCurrency = 'USD';

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [invoicesResponse, userResponse, statsResponse] = await Promise.all([
                    window.api.getInvoices(),
                    window.api.getUser(),
                    window.api.getInvoiceStatistics ? window.api.getInvoiceStatistics() : Promise.resolve({})
                ]);

                const invoices = invoicesResponse.invoices;
                const user = userResponse.user;
                const stats = statsResponse;

                // Set default currency
                defaultCurrency = user.default_currency || 'USD';

                // Update user info
                document.getElementById('user-name').textContent = user.company_name || 'Account';
                document.getElementById('welcome-message').textContent = `Welcome back, ${user.company_name || 'there'}! Here's your business overview.`;

                // Process data for charts and stats
                const processedData = processInvoiceData(invoices, currentChartPeriod);

                // Update stats cards
                document.getElementById('total-invoices').textContent = invoices.length;
                
                // Calculate total revenue and outstanding
                let totalRevenue = 0;
                let outstandingAmount = 0;
                let paidInvoices = 0;
                
                invoices.forEach(invoice => {
                    totalRevenue += invoice.total;
                    if (invoice.status !== 'paid') {
                        outstandingAmount += invoice.total;
                    } else {
                        paidInvoices++;
                    }
                });
                
                document.getElementById('total-revenue').textContent = window.api.formatCurrency(totalRevenue, defaultCurrency);
                document.getElementById('outstanding-amount').textContent = window.api.formatCurrency(outstandingAmount, defaultCurrency);
                document.getElementById('pending-invoices').textContent = invoices.length - paidInvoices;
                document.getElementById('free-invoices').textContent = user.free_invoices_remaining;

                // Calculate growth percentages (simplified for demo)
                const invoiceGrowth = processedData.lastMonth.invoices > 0 ? 
                    Math.round(((processedData.currentMonth.invoices - processedData.lastMonth.invoices) / processedData.lastMonth.invoices) * 100) : 
                    (processedData.currentMonth.invoices > 0 ? 100 : 0);
                
                const revenueGrowth = processedData.lastMonth.revenue > 0 ? 
                    Math.round(((processedData.currentMonth.revenue - processedData.lastMonth.revenue) / processedData.lastMonth.revenue) * 100) : 
                    (processedData.currentMonth.revenue > 0 ? 100 : 0);
                
                document.getElementById('invoice-growth').textContent = `${invoiceGrowth}%`;
                document.getElementById('revenue-growth').textContent = `${revenueGrowth}%`;

                // Update growth indicators
                const invoiceGrowthElement = document.getElementById('invoice-growth').closest('small');
                const revenueGrowthElement = document.getElementById('revenue-growth').closest('small');
                
                invoiceGrowthElement.innerHTML = invoiceGrowth >= 0 ? 
                    `<i class="fas fa-arrow-up me-1"></i> <span id="invoice-growth">${invoiceGrowth}%</span> from last month` :
                    `<i class="fas fa-arrow-down me-1"></i> <span id="invoice-growth">${Math.abs(invoiceGrowth)}%</span> from last month`;
                
                revenueGrowthElement.innerHTML = revenueGrowth >= 0 ? 
                    `<i class="fas fa-arrow-up me-1"></i> <span id="revenue-growth">${revenueGrowth}%</span> from last month` :
                    `<i class="fas fa-arrow-down me-1"></i> <span id="revenue-growth">${Math.abs(revenueGrowth)}%</span> from last month`;

                // Update account status
                const accountStatusBadge = document.getElementById('account-status-badge');
                const planDetails = document.getElementById('plan-details');
                
                if (user.is_premium) {
                    accountStatusBadge.textContent = 'Premium Plan';
                    accountStatusBadge.className = 'badge bg-warning mb-2';
                    planDetails.textContent = 'Unlimited invoices â€¢ Premium features';
                } else {
                    accountStatusBadge.textContent = 'Free Plan';
                    accountStatusBadge.className = 'badge bg-secondary mb-2';
                    planDetails.textContent = `${user.free_invoices_remaining} free invoices remaining`;
                }

                // Initialize charts with real data
                initRevenueChart(processedData.months, processedData.revenueData);
                initStatusChart(processedData.statusCounts);

                // Update monthly trends
                document.getElementById('current-month-invoices').textContent = processedData.currentMonth.invoices;
                document.getElementById('current-month-revenue').textContent = window.api.formatCurrency(processedData.currentMonth.revenue, defaultCurrency);
                document.getElementById('last-month-invoices').textContent = processedData.lastMonth.invoices;
                document.getElementById('last-month-revenue').textContent = window.api.formatCurrency(processedData.lastMonth.revenue, defaultCurrency);

                // Display recent invoices
                const recentInvoicesContainer = document.getElementById('recent-invoices-container');
                if (invoices.length > 0) {
                    const recentInvoices = invoices.slice(0, 5);
                    recentInvoicesContainer.innerHTML = `
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentInvoices.map(invoice => `
                                    <tr>
                                        <td class="fw-semibold">${invoice.invoice_number}</td>
                                        <td>${invoice.client_name}</td>
                                        <td>${window.api.formatDate(invoice.issue_date)}</td>
                                        <td>${window.api.formatCurrency(invoice.total, invoice.currency)}</td>
                                        <td>
                                            <span class="badge bg-${getStatusBadgeColor(invoice.status)}">
                                                ${invoice.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="view-invoice.html?id=${invoice.id}" class="btn btn-outline-primary" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button onclick="downloadInvoice(${invoice.id})" class="btn btn-outline-success" title="Download PDF">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    recentInvoicesContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                            <h5>No invoices yet</h5>
                            <p class="text-muted mb-4">Create your first invoice to get started</p>
                            <a href="create-invoice.html" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create First Invoice
                            </a>
                        </div>
                    `;
                }

                // Display activity timeline
                const activityTimeline = document.getElementById('activity-timeline');
                const activities = generateActivityTimeline(invoices);
                
                if (activities.length > 0) {
                    activityTimeline.innerHTML = activities.map(activity => `
                        <div class="activity-item d-flex mb-3">
                            <div class="activity-icon me-3">
                                <i class="${activity.icon} ${activity.iconColor}"></i>
                            </div>
                            <div class="activity-content">
                                <p class="mb-1 small fw-semibold">${activity.title}</p>
                                <p class="mb-1 small text-muted">${activity.description}</p>
                                <small class="text-muted">${activity.time}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityTimeline.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-history fa-2x text-muted mb-2"></i>
                            <p class="text-muted small">No recent activity</p>
                        </div>
                    `;
                }

            } catch (error) {
                window.api.showAlert('Failed to load dashboard: ' + error.message, 'error');
            }
        }

        // Helper function to get badge color based on status
        function getStatusBadgeColor(status) {
            switch (status) {
                case 'paid': return 'success';
                case 'pending': return 'warning';
                case 'overdue': return 'danger';
                case 'cancelled': return 'secondary';
                default: return 'secondary';
            }
        }

        // Download invoice function
        async function downloadInvoice(invoiceId) {
            try {
                await window.api.downloadInvoicePDF(invoiceId);
                window.api.showAlert('Invoice downloaded successfully!', 'success');
            } catch (error) {
                window.api.showAlert('Failed to download invoice: ' + error.message, 'error');
            }
        }

        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>