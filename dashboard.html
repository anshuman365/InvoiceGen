<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - InvoiceGen | Manage Your Invoices</title>
    <meta name="description" content="InvoiceGen dashboard - Manage your invoices, track revenue, and monitor your business performance in one place.">
    <meta name="keywords" content="invoice dashboard, billing management, revenue tracking, invoice analytics">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Dashboard - InvoiceGen">
    <meta property="og:description" content="Manage your invoices, track revenue, and monitor your business performance in one place.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://invoicegen.example.com/dashboard.html">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="InvoiceGen">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icons/favicon-16x16.png">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Styles -->
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-file-invoice-dollar"></i> InvoiceGen
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="invoices.html">
                            <i class="fas fa-file-invoice me-1"></i> Invoices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-invoice.html">
                            <i class="fas fa-plus-circle me-1"></i> Create Invoice
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="billing.html">
                            <i class="fas fa-wallet me-1"></i> Billing
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> 
                            <span id="user-name">Account</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-link"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="container">
            <!-- Welcome Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 fw-bold text-primary mb-1">Dashboard</h1>
                            <p class="text-muted mb-0" id="welcome-message">Welcome back! Here's your business overview.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="create-invoice.html" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>New Invoice
                            </a>
                            <button class="btn btn-outline-secondary" id="refresh-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-primary rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="total-invoices">0</h2>
                                    <p class="card-text mb-0">Total Invoices</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><i class="fas fa-arrow-up me-1"></i> <span id="invoice-growth">0%</span> from last month</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-success rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="total-revenue">$0.00</h2>
                                    <p class="card-text mb-0">Total Revenue</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><i class="fas fa-arrow-up me-1"></i> <span id="revenue-growth">0%</span> from last month</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-info rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="free-invoices">0</h2>
                                    <p class="card-text mb-0">Free Invoices Left</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-gift"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small id="invoice-status">You're on the free plan</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card bg-warning rounded-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title mb-0" id="outstanding-amount">$0.00</h2>
                                    <p class="card-text mb-0">Outstanding</p>
                                </div>
                                <div class="display-4 opacity-75">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small><span id="pending-invoices">0</span> unpaid invoices</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="row">
                <!-- Revenue Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Revenue Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="create-invoice.html" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus-circle me-2"></i>Create New Invoice
                                </a>
                                <a href="invoices.html" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>View All Invoices
                                </a>
                                <a href="billing.html" class="btn btn-outline-primary">
                                    <i class="fas fa-wallet me-2"></i>Manage Billing
                                </a>
                                <a href="settings.html" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-2"></i>Account Settings
                                </a>
                            </div>

                            <!-- Account Status -->
                            <div class="mt-4 p-3 bg-light rounded-3">
                                <h6 class="fw-semibold text-muted">Account Status</h6>
                                <div id="account-status-badge" class="badge bg-secondary mb-2">Free Plan</div>
                                <p class="small mb-2 text-muted" id="plan-details">10 free invoices per month</p>
                                <a href="billing.html" class="btn btn-sm btn-warning w-100">
                                    <i class="fas fa-crown me-1"></i>Upgrade Plan
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Invoices & Activity -->
            <div class="row">
                <!-- Recent Invoices -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Recent Invoices</h5>
                            <a href="invoices.html" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" id="recent-invoices-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted">Loading your invoices...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <h5 class="card-title mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <div class="activity-timeline" id="activity-timeline">
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon me-3">
                                        <i class="fas fa-file-invoice text-primary"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p class="mb-1 small">New invoice created</p>
                                        <small class="text-muted">2 hours ago</small>
                                    </div>
                                </div>
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon me-3">
                                        <i class="fas fa-user text-success"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p class="mb-1 small">Client added to database</p>
                                        <small class="text-muted">1 day ago</small>
                                    </div>
                                </div>
                                <div class="activity-item d-flex mb-3">
                                    <div class="activity-icon me-3">
                                        <i class="fas fa-download text-info"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p class="mb-1 small">Invoice downloaded as PDF</p>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support Card -->
                    <div class="card mt-4 bg-light">
                        <div class="card-body text-center">
                            <i class="fas fa-headset fa-2x text-primary mb-3"></i>
                            <h6>Need Help?</h6>
                            <p class="small text-muted mb-3">Our support team is here to help you</p>
                            <a href="#" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-envelope me-1"></i>Contact Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2023 InvoiceGen. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="main.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>

    <script>
        // Check authentication
        if (!window.api.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Logout handler
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            window.api.logout();
        });

        // Refresh button handler
        document.getElementById('refresh-btn').addEventListener('click', function() {
            const button = this;
            const icon = button.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            loadDashboard();
            
            // Remove spinning after 2 seconds
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 2000);
        });

        // Chart initialization
        let revenueChart;
        function initRevenueChart(labels, data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const [invoicesResponse, userResponse] = await Promise.all([
                    window.api.getInvoices(),
                    window.api.getUser()
                ]);

                const invoices = invoicesResponse.invoices;
                const user = userResponse.user;

                // Update user info
                document.getElementById('user-name').textContent = user.company_name || 'Account';
                document.getElementById('welcome-message').textContent = `Welcome back, ${user.company_name || 'there'}! Here's your business overview.`;

                // Update stats
                document.getElementById('total-invoices').textContent = invoices.length;
                
                // Calculate total revenue
                let totalRevenue = 0;
                let outstandingAmount = 0;
                let paidInvoices = 0;
                
                invoices.forEach(invoice => {
                    totalRevenue += invoice.total;
                    if (invoice.status !== 'paid') {
                        outstandingAmount += invoice.total;
                    } else {
                        paidInvoices++;
                    }
                });
                
                document.getElementById('total-revenue').textContent = window.api.formatCurrency(totalRevenue, user.default_currency);
                document.getElementById('outstanding-amount').textContent = window.api.formatCurrency(outstandingAmount, user.default_currency);
                document.getElementById('pending-invoices').textContent = invoices.length - paidInvoices;
                document.getElementById('free-invoices').textContent = user.free_invoices_remaining;

                // Update growth percentages (mock data for demo)
                document.getElementById('invoice-growth').textContent = '12%';
                document.getElementById('revenue-growth').textContent = '18%';

                // Update account status
                const accountStatusBadge = document.getElementById('account-status-badge');
                const planDetails = document.getElementById('plan-details');
                
                if (user.is_premium) {
                    accountStatusBadge.textContent = 'Premium Plan';
                    accountStatusBadge.className = 'badge bg-warning mb-2';
                    planDetails.textContent = 'Unlimited invoices • Premium features';
                } else {
                    accountStatusBadge.textContent = 'Free Plan';
                    accountStatusBadge.className = 'badge bg-secondary mb-2';
                    planDetails.textContent = `${user.free_invoices_remaining} free invoices remaining`;
                }

                // Initialize chart with mock data (in a real app, you'd get this from the API)
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
                const revenueData = [1200, 1900, 1500, 2200, 1800, 2500, 2800];
                initRevenueChart(months, revenueData);

                // Display recent invoices
                const recentInvoicesContainer = document.getElementById('recent-invoices-container');
                if (invoices.length > 0) {
                    const recentInvoices = invoices.slice(0, 5);
                    recentInvoicesContainer.innerHTML = `
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentInvoices.map(invoice => `
                                    <tr>
                                        <td class="fw-semibold">${invoice.invoice_number}</td>
                                        <td>${invoice.client_name}</td>
                                        <td>${window.api.formatDate(invoice.issue_date)}</td>
                                        <td>${window.api.formatCurrency(invoice.total, invoice.currency)}</td>
                                        <td>
                                            <span class="badge bg-${invoice.status === 'paid' ? 'success' : 'warning'}">
                                                ${invoice.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="view-invoice.html?id=${invoice.id}" class="btn btn-outline-primary" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button onclick="downloadInvoice(${invoice.id})" class="btn btn-outline-success" title="Download PDF">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    recentInvoicesContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                            <h5>No invoices yet</h5>
                            <p class="text-muted mb-4">Create your first invoice to get started</p>
                            <a href="create-invoice.html" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create First Invoice
                            </a>
                        </div>
                    `;
                }

            } catch (error) {
                window.api.showAlert('Failed to load dashboard: ' + error.message, 'error');
            }
        }

        // Download invoice function
        async function downloadInvoice(invoiceId) {
            try {
                await window.api.downloadInvoicePDF(invoiceId);
                window.api.showAlert('Invoice downloaded successfully!', 'success');
            } catch (error) {
                window.api.showAlert('Failed to download invoice: ' + error.message, 'error');
            }
        }

        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>