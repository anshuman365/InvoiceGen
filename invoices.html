<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - InvoiceGen | Manage Your Invoices</title>
    <meta name="description" content="Manage all your invoices in one place. View, edit, download, and track your invoice history with InvoiceGen.">
    <meta name="keywords" content="invoice management, view invoices, invoice history, billing records">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Invoices - InvoiceGen">
    <meta property="og:description" content="Manage all your invoices in one place. View, edit, download, and track your invoice history with InvoiceGen.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://invoicegen.example.com/invoices.html">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="InvoiceGen">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icons/favicon-16x16.png">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-file-invoice-dollar"></i> InvoiceGen
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="invoices.html">
                            <i class="fas fa-file-invoice me-1"></i> Invoices
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-invoice.html">
                            <i class="fas fa-plus-circle me-1"></i> Create Invoice
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="billing.html">
                            <i class="fas fa-wallet me-1"></i> Billing
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> Account
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-link"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="container">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 fw-bold text-primary mb-1">All Invoices</h1>
                            <p class="text-muted mb-0">Manage and track all your invoices</p>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-filter me-2"></i>Filter
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-filter="all">All Invoices</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="paid">Paid</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="pending">Pending</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="overdue">Overdue</a></li>
                                </ul>
                            </div>
                            <a href="create-invoice.html" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>New Invoice
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card border-0 bg-primary bg-opacity-10">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h4 class="mb-0 fw-bold" id="total-invoices-count">0</h4>
                                    <small class="" style="color:#676767">Total Invoices</small>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-file-invoice fa-2x text-primary opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card border-0 bg-success bg-opacity-10">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h4 class="mb-0 fw-bold" id="paid-invoices-count">0</h4>
                                    <small class="" style="color:#676767">Paid Invoices</small>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card border-0 bg-warning bg-opacity-10">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h4 class="mb-0 fw-bold" id="pending-invoices-count">0</h4>
                                    <small class="" style="color:#676767">Pending</small>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-clock fa-2x text-warning opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card border-0 bg-danger bg-opacity-10">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h4 class="mb-0 fw-bold" id="overdue-invoices-count">0</h4>
                                    <small class="" style="color:#676767">Overdue</small>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Search Invoices</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="fas fa-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0" id="search-invoices" 
                                               placeholder="Search by client, invoice number...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Status</label>
                                    <select class="form-select" id="status-filter">
                                        <option value="all">All Status</option>
                                        <option value="paid">Paid</option>
                                        <option value="pending">Pending</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Date Range</label>
                                    <select class="form-select" id="date-filter">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100" id="reset-filters">
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Invoice List</h5>
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted small" id="invoices-count">0 invoices</span>
                                <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" id="invoices-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted">Loading your invoices...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="row" id="empty-state" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-file-invoice fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted mb-3">No Invoices Yet</h4>
                            <p class="text-muted mb-4">Create your first invoice to get started with InvoiceGen</p>
                            <a href="create-invoice.html" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus me-2"></i>Create First Invoice
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2023 InvoiceGen. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="main.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>

    <script>
        // Check authentication
        if (!window.api.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Logout handler
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            window.api.logout();
        });

        let allInvoices = [];
        let filteredInvoices = [];

        // Refresh button handler
        document.getElementById('refresh-btn').addEventListener('click', function() {
            const button = this;
            const icon = button.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            loadInvoices();
            
            // Remove spinning after 2 seconds
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 2000);
        });

        // Filter functionality
        function filterInvoices() {
            const searchTerm = document.getElementById('search-invoices').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            filteredInvoices = allInvoices.filter(invoice => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    invoice.client_name.toLowerCase().includes(searchTerm) ||
                    invoice.invoice_number.toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || invoice.status === statusFilter;
                
                // Date filter
                let matchesDate = true;
                if (dateFilter !== 'all') {
                    const invoiceDate = new Date(invoice.issue_date);
                    const today = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            matchesDate = invoiceDate.toDateString() === today.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = invoiceDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                            matchesDate = invoiceDate >= monthAgo;
                            break;
                        case 'quarter':
                            const quarterAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                            matchesDate = invoiceDate >= quarterAgo;
                            break;
                        case 'year':
                            const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                            matchesDate = invoiceDate >= yearAgo;
                            break;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            displayInvoices(filteredInvoices);
        }

        // Display invoices in table
        function displayInvoices(invoices) {
            const container = document.getElementById('invoices-container');
            const emptyState = document.getElementById('empty-state');
            const invoicesCount = document.getElementById('invoices-count');
            
            invoicesCount.textContent = `${invoices.length} invoice${invoices.length !== 1 ? 's' : ''}`;
            
            if (invoices.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.style.display = 'block';
            
            container.innerHTML = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="color:#3498db">Invoice #</th>
                            <th style="color:#3498db">Client</th>
                            <th style="color:#3498db">Issue Date</th>
                            <th style="color:#3498db">Due Date</th>
                            <th style="color:#3498db">Amount</th>
                            <th style="color:#3498db">Status</th>
                            <th style="color:#3498db">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(invoice => `
                            <tr>
                                <td>
                                    <div class="fw-semibold">${invoice.invoice_number}</div>
                                    <small class="" style="color:#848f67">${invoice.currency}</small>
                                </td>
                                <td>
                                    <div class="fw-semibold">${invoice.client_name}</div>
                                    ${invoice.client_company ? `<small class="" style="color:#848f67">${invoice.client_company}</small>` : ''}
                                </td>
                                <td>
                                    <div>${window.api.formatDate(invoice.issue_date)}</div>
                                    <small class="" style="color:#848f67">Issued</small>
                                </td>
                                <td>
                                    <div class="${isOverdue(invoice) ? 'text-danger fw-semibold' : ''}">
                                        ${window.api.formatDate(invoice.due_date)}
                                    </div>
                                    <small class="" style="color:#848f67">Due</small>
                                </td>
                                <td>
                                    <div class="fw-semibold">${window.api.formatCurrency(invoice.total, invoice.currency)}</div>
                                    <small class="" style="color:#848f67">Total</small>
                                </td>
                                <td>
                                    ${getStatusBadge(invoice)}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="view-invoice.html?id=${invoice.id}" class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button onclick="downloadInvoice(${invoice.id})" class="btn btn-outline-success" title="Download PDF">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button onclick="deleteInvoice(${invoice.id})" class="btn btn-outline-danger" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Check if invoice is overdue
        function isOverdue(invoice) {
            if (invoice.status === 'paid') return false;
            const dueDate = new Date(invoice.due_date);
            const today = new Date();
            return dueDate < today;
        }

        // Get status badge HTML
        function getStatusBadge(invoice) {
            if (invoice.status === 'paid') {
                return '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Paid</span>';
            } else if (isOverdue(invoice)) {
                return '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Overdue</span>';
            } else {
                return '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pending</span>';
            }
        }

        // Update stats counters
        function updateStats(invoices) {
            const total = invoices.length;
            const paid = invoices.filter(inv => inv.status === 'paid').length;
            const pending = invoices.filter(inv => inv.status === 'pending' && !isOverdue(inv)).length;
            const overdue = invoices.filter(inv => isOverdue(inv)).length;
            
            document.getElementById('total-invoices-count').textContent = total;
            document.getElementById('paid-invoices-count').textContent = paid;
            document.getElementById('pending-invoices-count').textContent = pending;
            document.getElementById('overdue-invoices-count').textContent = overdue;
        }

        // Download invoice
        async function downloadInvoice(invoiceId) {
            try {
                await window.api.downloadInvoicePDF(invoiceId);
                window.api.showAlert('Invoice downloaded successfully!', 'success');
            } catch (error) {
                window.api.showAlert('Failed to download invoice: ' + error.message, 'error');
            }
        }

        // Delete invoice
        async function deleteInvoice(invoiceId) {
            if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                return;
            }
            
            try {
                await window.api.deleteInvoice(invoiceId);
                window.api.showAlert('Invoice deleted successfully!', 'success');
                loadInvoices(); // Reload the list
            } catch (error) {
                window.api.showAlert('Failed to delete invoice: ' + error.message, 'error');
            }
        }

        // Load invoices
        async function loadInvoices() {
            try {
                const response = await window.api.getInvoices();
                allInvoices = response.invoices;
                filteredInvoices = [...allInvoices];
                
                updateStats(allInvoices);
                displayInvoices(filteredInvoices);
                
            } catch (error) {
                window.api.showAlert('Failed to load invoices: ' + error.message, 'error');
            }
        }

        // Initialize event listeners
        document.getElementById('search-invoices').addEventListener('input', filterInvoices);
        document.getElementById('status-filter').addEventListener('change', filterInvoices);
        document.getElementById('date-filter').addEventListener('change', filterInvoices);
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('search-invoices').value = '';
            document.getElementById('status-filter').value = 'all';
            document.getElementById('date-filter').value = 'all';
            filterInvoices();
        });

        // Dropdown filter listeners
        document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const filter = this.getAttribute('data-filter');
                document.getElementById('status-filter').value = filter;
                filterInvoices();
            });
        });

        // Load invoices when page loads
        document.addEventListener('DOMContentLoaded', loadInvoices);
    </script>
</body>
</html>